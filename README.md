# 灵足电机驱动开源

## 序言 
我在开发灵足电机的时候在网上查询资料发现除了官方文档以外基本没有keil5+cubeMX开发案例所以我尝试把电机基础部分(运控模式)给集成封装好。此代码是02和05的使用封装,32型号为stm32F407IGH6(大疆C板),也可以根据使用需求修改或者添加其他型号。需注意电机出厂时电机id默认为127(0x7F)。

## 功能(封装内容)
以下函数均在motor_LZ中(在motor_LZ.h中第8行motor_LZ_N修改电机数量)

1. 基础封装第75行motor_LZ_Handle_send是把电机要发送数据传入到CAN_TxHeaderTypeDef  motor_LZ_tx结构体中。注意灵足电机使用扩展帧所以CAN_TxHeaderTypeDef中的IDE要赋为CAN_ID_EXT意味着使用can协议中的扩展帧，此时StdId不使用,协议使用ExtId这个。需注意在协议当中29位ID中0-7bit为低位,24-28为高位。

2. 对于通信类型1(运控模式电机控制指令)
    这是电机控制的核心由两个函数(motor_LZ_send_handle和motor_LZ_send)构成如果想修改型号只需要把映射和最大值最小值保护修改成想要的型号就可以了。

3. 对于通信类型2(电机反馈数据)
   在290行HAL_CAN_RxFifo0MsgPendingCallback为can发Fifo0回调函数,主要运用回调函数性质(在数据接收结束时进入此函数),如果想改成can2只需要修改第292行的if中的判断(我已经默认把can1和can2启动),还有就是第261行的motor_LC_recv_data函数这个函数是对电机返回数据的解析,如果想修改或者添加型号只需要修改对应值的映射。返回标识符是0x02
4. 对于通信类型3和通信类型4(电机的使能和停止)
   因为这两个是相关所以我放在了一起是由motor_LZ_enable函数(使能)和motor_LZ_lose函数(停止)构成。在电机官方文档里面在8-23bit区是 用来标识主CAN_ID 这个据我研究可以随便给个uint8_t的值 在我代码中是在motor_LZ.h中的第9行的motor_LZ_user_id修改。
5. 对于通信类型6和通信类型7(电机零点设置和CAN_ID设置)
   在代码中由motor_LZ_zero函数(零点设置)和motor_LZ_set_CAN_ID函数(CAN_ID设置)这两个代码运行默认会失能电机在motor_LZ_zero函数中会重新使能在motor_LZ_set_CAN_ID函数会默认不使能。
6. 对于通信类型24(电机主动上报帧)
   灵足电机默认不主动返回电机数据,需要通过类型24开启,在代码中为此motor_LZ_active_recv函数,此函数当F_CMD传入00为关01为开。开启后默认10ms返回一次电机数据,需注意此时返回的是0x18标识符而不是0x02。

代码的使用上电要使能才能运行电机,然后通过类型1控制电机。在电机使用需要创user_send_Lz结构体(电机发送)通过motor_LZ_send_init函数初始化传入地址和从const user_recv_Lz结构体(电机接收)通过motor_LZ_recv_return接收数据指针然后传入地址。

## 声明
    此代码为开源代码。
    此代码是通过灵足官方文档配置而来。
    此代码的can的配置默认使用大疆创新的代码。   
    如果用此代码造成电机损坏本人均不负责。


